Sub refresh_new()

Application.Workbooks.Open "Z:\Compartilhado\Consultas\IPCA\Coleta de Preços - IPCA.xlsx", ReadOnly:=True

Dim sh_F As Worksheet
Set sh_F = Worksheets("Fontes")

'CEAGESP
With sh_F
    .Activate
    .Cells(1, 2) = "CEAGESP"
    .Range("B5").ListObject.QueryTable.refresh BackgroundQuery:=False
    .Range("T_COTACOES_FONTE[#All]").Select
    .Range("T_COTACOES_FONTE[[#Headers],[Produto]]").Activate
End With

'criar tabela dinamica
    ActiveWorkbook.Sheets.Add
    ActiveWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:= _
        "T_COTACOES_FONTE", Version:=6).CreatePivotTable TableDestination:= _
        "Sheet1!R3C1", TableName:="PivotTable1", DefaultVersion:=6
    Sheets("Sheet1").Select
    Cells(3, 1).Select
    With ActiveSheet.PivotTables("PivotTable1").PivotCache
        .RefreshOnFileOpen = False
        .MissingItemsLimit = xlMissingItemsDefault
    End With
    ActiveSheet.PivotTables("PivotTable1").RepeatAllLabels xlRepeatLabels
    With ActiveSheet.PivotTables("PivotTable1").PivotFields("Produto")
        .Orientation = xlColumnField
        .Position = 1
    End With
    With ActiveSheet.PivotTables("PivotTable1").PivotFields("Data")
        .Orientation = xlRowField
        .Position = 1
    End With
    ActiveSheet.PivotTables("PivotTable1").AddDataField ActiveSheet.PivotTables( _
        "PivotTable1").PivotFields("Preço"), "Sum of Preço", xlSum
        
Range("A4").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy

'colar tabela em outra planilha
ActiveWorkbook.Sheets.Add
Sheets("Sheet2").Select
Range("A1").PasteSpecial xlPasteAll

'exclusao linha e coluna grand total
ActiveCell.End(xlToRight).EntireColumn.Delete
Range("A1").End(xlDown).EntireRow.Delete

'arrumar a data
Range("A1").Select
Range("A1").EntireColumn.Insert

f_row = Range("B2").Row
l_row = Range("B2").End(xlDown).Row
l_column = Range("B1").End(xlToRight).Column

Range("A" & CStr(f_row)).FormulaR1C1 = "=RC[1]*1"
Range("A" & CStr(f_row)).Copy
Range("A" & CStr(f_row), "A" & CStr(l_row)).PasteSpecial xlPasteFormulas
Range("A" & CStr(f_row), "A" & CStr(l_row)).Copy
Range("A" & CStr(f_row)).Offset(0, 1).PasteSpecial xlPasteValues
Range("B" & CStr(f_row), "B" & CStr(l_row)).NumberFormat = "m/d/yyyy"
Range("A1").EntireColumn.Delete

'ordenar a data
Range("A1").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Sort.SortFields.Clear
ActiveSheet.Sort.SortFields.Add2 Key:=Range( _
    "A" & CStr(f_row), "A" & CStr(l_row)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
    xlSortNormal
With ActiveSheet.Sort
    .SetRange Range("A1", Cells(l_row, l_column))
    .Header = xlYes
    .MatchCase = False
    .Orientation = xlTopToBottom
    .SortMethod = xlPinYin
    .Apply
    End With
Range("A1").CurrentRegion.Copy

'colar na planilha correspondente
Windows("Base_macro.xlsm").Activate
Worksheets("Ceagesp").Activate
Range("B2").PasteSpecial xlPasteAll
Application.CutCopyMode = False

'-------------------------------------------------------------------------

'CEASA
Windows("Coleta de Preços - IPCA.xlsx").Activate
With sh_F
    .Activate
    .Cells(1, 2) = "CEASA"
    .Range("B5").ListObject.QueryTable.refresh BackgroundQuery:=False
    .Range("T_COTACOES_FONTE[#All]").Select
    .Range("T_COTACOES_FONTE[[#Headers],[Produto]]").Activate
End With
        
'criar tabela dinamica
    ActiveWorkbook.Sheets.Add
    ActiveWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:= _
        "T_COTACOES_FONTE", Version:=6).CreatePivotTable TableDestination:= _
        "Sheet3!R3C1", TableName:="PivotTable2", DefaultVersion:=6
    Sheets("Sheet3").Select
    Cells(3, 1).Select
    With ActiveSheet.PivotTables("PivotTable2").PivotCache
        .RefreshOnFileOpen = False
        .MissingItemsLimit = xlMissingItemsDefault
    End With
    ActiveSheet.PivotTables("PivotTable2").RepeatAllLabels xlRepeatLabels
    With ActiveSheet.PivotTables("PivotTable2").PivotFields("Produto")
        .Orientation = xlColumnField
        .Position = 1
    End With
    With ActiveSheet.PivotTables("PivotTable2").PivotFields("Data")
        .Orientation = xlRowField
        .Position = 1
    End With
    ActiveSheet.PivotTables("PivotTable2").AddDataField ActiveSheet.PivotTables( _
        "PivotTable2").PivotFields("Preço"), "Sum of Preço", xlSum
        
Range("A4").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy

'colar tabela em outra planilha
ActiveWorkbook.Sheets.Add
Sheets("Sheet4").Select
Range("A1").PasteSpecial xlPasteAll

'exclusao linha e coluna grand total
ActiveCell.End(xlToRight).EntireColumn.Delete
Range("A1").End(xlDown).EntireRow.Delete

'arrumar a data
Range("A1").Select
Range("A1").EntireColumn.Insert

f_row = Range("B2").Row
l_row = Range("B2").End(xlDown).Row
l_column = Range("B1").End(xlToRight).Column

Range("A" & CStr(f_row)).FormulaR1C1 = "=RC[1]*1"
Range("A" & CStr(f_row)).Copy
Range("A" & CStr(f_row), "A" & CStr(l_row)).PasteSpecial xlPasteFormulas
Range("A" & CStr(f_row), "A" & CStr(l_row)).Copy
Range("A" & CStr(f_row)).Offset(0, 1).PasteSpecial xlPasteValues
Range("B" & CStr(f_row), "B" & CStr(l_row)).NumberFormat = "m/d/yyyy"
Range("A1").EntireColumn.Delete

'ordenar a data
Range("A1").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Sort.SortFields.Clear
ActiveSheet.Sort.SortFields.Add2 Key:=Range( _
    "A" & CStr(f_row), "A" & CStr(l_row)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
    xlSortNormal
With ActiveSheet.Sort
    .SetRange Range("A1", Cells(l_row, l_column))
    .Header = xlYes
    .MatchCase = False
    .Orientation = xlTopToBottom
    .SortMethod = xlPinYin
    .Apply
    End With
Range("A1").CurrentRegion.Copy

'colar na planilha correspondente
Windows("Base_macro.xlsm").Activate
Worksheets("CEASA").Activate
Range("B2").PasteSpecial xlPasteAll
Application.CutCopyMode = False
        
'-------------------------------------------------------------------------

'IEA_atacadista
Windows("Coleta de Preços - IPCA.xlsx").Activate
With sh_F
    .Activate
    .Cells(1, 2) = "IEA - Atacadista"
    .Range("B5").ListObject.QueryTable.refresh BackgroundQuery:=False
    .Range("T_COTACOES_FONTE[#All]").Select
    .Range("T_COTACOES_FONTE[[#Headers],[Produto]]").Activate
End With
        
'criar tabela dinamica
    ActiveWorkbook.Sheets.Add
    ActiveWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:= _
        "T_COTACOES_FONTE", Version:=6).CreatePivotTable TableDestination:= _
        "Sheet5!R3C1", TableName:="PivotTable3", DefaultVersion:=6
    Sheets("Sheet5").Select
    Cells(3, 1).Select
    With ActiveSheet.PivotTables("PivotTable3").PivotCache
        .RefreshOnFileOpen = False
        .MissingItemsLimit = xlMissingItemsDefault
    End With
    ActiveSheet.PivotTables("PivotTable3").RepeatAllLabels xlRepeatLabels
    With ActiveSheet.PivotTables("PivotTable3").PivotFields("Produto")
        .Orientation = xlColumnField
        .Position = 1
    End With
    With ActiveSheet.PivotTables("PivotTable3").PivotFields("Data")
        .Orientation = xlRowField
        .Position = 1
    End With
    ActiveSheet.PivotTables("PivotTable3").AddDataField ActiveSheet.PivotTables( _
        "PivotTable3").PivotFields("Preço"), "Sum of Preço", xlSum
        
Range("A4").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy

'colar tabela em outra planilha
ActiveWorkbook.Sheets.Add
Sheets("Sheet6").Select
Range("A1").PasteSpecial xlPasteAll

'exclusao linha e coluna grand total
ActiveCell.End(xlToRight).EntireColumn.Delete
Range("A1").End(xlDown).EntireRow.Delete

'arrumar a data
Range("A1").Select
Range("A1").EntireColumn.Insert

f_row = Range("B2").Row
l_row = Range("B2").End(xlDown).Row
l_column = Range("B1").End(xlToRight).Column

Range("A" & CStr(f_row)).FormulaR1C1 = "=RC[1]*1"
Range("A" & CStr(f_row)).Copy
Range("A" & CStr(f_row), "A" & CStr(l_row)).PasteSpecial xlPasteFormulas
Range("A" & CStr(f_row), "A" & CStr(l_row)).Copy
Range("A" & CStr(f_row)).Offset(0, 1).PasteSpecial xlPasteValues
Range("B" & CStr(f_row), "B" & CStr(l_row)).NumberFormat = "m/d/yyyy"
Range("A1").EntireColumn.Delete

'ordenar a data
Range("A1").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Sort.SortFields.Clear
ActiveSheet.Sort.SortFields.Add2 Key:=Range( _
    "A" & CStr(f_row), "A" & CStr(l_row)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
    xlSortNormal
With ActiveSheet.Sort
    .SetRange Range("A1", Cells(l_row, l_column))
    .Header = xlYes
    .MatchCase = False
    .Orientation = xlTopToBottom
    .SortMethod = xlPinYin
    .Apply
    End With
Range("A1").CurrentRegion.Copy

'colar na planilha correspondente
Windows("Base_macro.xlsm").Activate
Worksheets("IEA_atacadista").Activate
Range("B2").PasteSpecial xlPasteAll
Application.CutCopyMode = False

'-------------------------------------------------------------------------

'IEA_produtor
Windows("Coleta de Preços - IPCA.xlsx").Activate
With sh_F
    .Activate
    .Cells(1, 2) = "IEA - Produtor"
    .Range("B5").ListObject.QueryTable.refresh BackgroundQuery:=False
    .Range("T_COTACOES_FONTE[#All]").Select
    .Range("T_COTACOES_FONTE[[#Headers],[Produto]]").Activate
End With
        
'criar tabela dinamica
    ActiveWorkbook.Sheets.Add
    ActiveWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:= _
        "T_COTACOES_FONTE", Version:=6).CreatePivotTable TableDestination:= _
        "Sheet7!R3C1", TableName:="PivotTable4", DefaultVersion:=6
    Sheets("Sheet7").Select
    Cells(3, 1).Select
    With ActiveSheet.PivotTables("PivotTable4").PivotCache
        .RefreshOnFileOpen = False
        .MissingItemsLimit = xlMissingItemsDefault
    End With
    ActiveSheet.PivotTables("PivotTable4").RepeatAllLabels xlRepeatLabels
    With ActiveSheet.PivotTables("PivotTable4").PivotFields("Produto")
        .Orientation = xlColumnField
        .Position = 1
    End With
    With ActiveSheet.PivotTables("PivotTable4").PivotFields("Data")
        .Orientation = xlRowField
        .Position = 1
    End With
    ActiveSheet.PivotTables("PivotTable4").AddDataField ActiveSheet.PivotTables( _
        "PivotTable4").PivotFields("Preço"), "Sum of Preço", xlSum
        
Range("A4").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy

'colar tabela em outra planilha
ActiveWorkbook.Sheets.Add
Sheets("Sheet8").Select
Range("A1").PasteSpecial xlPasteAll

'exclusao linha e coluna grand total
ActiveCell.End(xlToRight).EntireColumn.Delete
Range("A1").End(xlDown).EntireRow.Delete

'arrumar a data
Range("A1").Select
Range("A1").EntireColumn.Insert

f_row = Range("B2").Row
l_row = Range("B2").End(xlDown).Row
l_column = Range("B1").End(xlToRight).Column

Range("A" & CStr(f_row)).FormulaR1C1 = "=RC[1]*1"
Range("A" & CStr(f_row)).Copy
Range("A" & CStr(f_row), "A" & CStr(l_row)).PasteSpecial xlPasteFormulas
Range("A" & CStr(f_row), "A" & CStr(l_row)).Copy
Range("A" & CStr(f_row)).Offset(0, 1).PasteSpecial xlPasteValues
Range("B" & CStr(f_row), "B" & CStr(l_row)).NumberFormat = "m/d/yyyy"
Range("A1").EntireColumn.Delete

'ordenar a data
Range("A1").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Sort.SortFields.Clear
ActiveSheet.Sort.SortFields.Add2 Key:=Range( _
    "A" & CStr(f_row), "A" & CStr(l_row)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
    xlSortNormal
With ActiveSheet.Sort
    .SetRange Range("A1", Cells(l_row, l_column))
    .Header = xlYes
    .MatchCase = False
    .Orientation = xlTopToBottom
    .SortMethod = xlPinYin
    .Apply
    End With
Range("A1").CurrentRegion.Copy

'colar na planilha correspondente
Windows("Base_macro.xlsm").Activate
Worksheets("IEA_produtor").Activate
Range("B2").PasteSpecial xlPasteAll
Application.CutCopyMode = False

'-------------------------------------------------------------------------

'ESALQ
Windows("Coleta de Preços - IPCA.xlsx").Activate
With sh_F
    .Activate
    .Cells(1, 2) = "ESALQ/CEPEA"
    .Range("B5").ListObject.QueryTable.refresh BackgroundQuery:=False
    .Range("T_COTACOES_FONTE[#All]").Select
    .Range("T_COTACOES_FONTE[[#Headers],[Produto]]").Activate
End With
        
'criar tabela dinamica
    ActiveWorkbook.Sheets.Add
    ActiveWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:= _
        "T_COTACOES_FONTE", Version:=6).CreatePivotTable TableDestination:= _
        "Sheet9!R3C1", TableName:="PivotTable5", DefaultVersion:=6
    Sheets("Sheet9").Select
    Cells(3, 1).Select
    With ActiveSheet.PivotTables("PivotTable5").PivotCache
        .RefreshOnFileOpen = False
        .MissingItemsLimit = xlMissingItemsDefault
    End With
    ActiveSheet.PivotTables("PivotTable5").RepeatAllLabels xlRepeatLabels
    With ActiveSheet.PivotTables("PivotTable5").PivotFields("Produto")
        .Orientation = xlColumnField
        .Position = 1
    End With
    With ActiveSheet.PivotTables("PivotTable5").PivotFields("Data")
        .Orientation = xlRowField
        .Position = 1
    End With
    ActiveSheet.PivotTables("PivotTable5").AddDataField ActiveSheet.PivotTables( _
        "PivotTable5").PivotFields("Preço"), "Sum of Preço", xlSum
        
Range("A4").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy

'colar tabela em outra planilha
ActiveWorkbook.Sheets.Add
Sheets("Sheet10").Select
Range("A1").PasteSpecial xlPasteAll

'exclusao linha e coluna grand total
ActiveCell.End(xlToRight).EntireColumn.Delete
Range("A1").End(xlDown).EntireRow.Delete

'arrumar a data
Range("A1").Select
Range("A1").EntireColumn.Insert

f_row = Range("B2").Row
l_row = Range("B2").End(xlDown).Row
l_column = Range("B1").End(xlToRight).Column

Range("A" & CStr(f_row)).FormulaR1C1 = "=RC[1]*1"
Range("A" & CStr(f_row)).Copy
Range("A" & CStr(f_row), "A" & CStr(l_row)).PasteSpecial xlPasteFormulas
Range("A" & CStr(f_row), "A" & CStr(l_row)).Copy
Range("A" & CStr(f_row)).Offset(0, 1).PasteSpecial xlPasteValues
Range("B" & CStr(f_row), "B" & CStr(l_row)).NumberFormat = "m/d/yyyy"
Range("A1").EntireColumn.Delete

'ordenar a data
Range("A1").Select
Range(Selection, Selection.End(xlToRight)).Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Sort.SortFields.Clear
ActiveSheet.Sort.SortFields.Add2 Key:=Range( _
    "A" & CStr(f_row), "A" & CStr(l_row)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
    xlSortNormal
With ActiveSheet.Sort
    .SetRange Range("A1", Cells(l_row, l_column))
    .Header = xlYes
    .MatchCase = False
    .Orientation = xlTopToBottom
    .SortMethod = xlPinYin
    .Apply
    End With
Range("A1").CurrentRegion.Copy

'colar na planilha correspondente
Windows("Base_macro.xlsm").Activate
Worksheets("ESALQ").Activate
Range("B2").PasteSpecial xlPasteAll
Application.CutCopyMode = False


End Sub